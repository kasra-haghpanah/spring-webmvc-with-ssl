<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!--<title th:text="${title}">title</title>-->
</head>

<!--
<link media="all" th:href="@{'/resource/'+${version}+'?path=css/upload-download.css'}" rel="stylesheet"/>
<script type="text/javascript" th:src="@{'/resource/'+${version}+'?path=js/upload-download.js'}"></script>
-->

<script type="text/javascript" th:src="@{'/resource/'+${version}+'?path=js/html5.js'}"></script>

<script type="application/javascript">



        const jwtToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."; // Ø§ÛŒÙ†Ùˆ Ø§Ø² login API Ø¨Ú¯ÛŒØ±

        // Ø§ØªØµØ§Ù„ Ø¨Ø§ ØªÙˆÚ©Ù† Ø¯Ø± query string
        //const socket = new WebSocket(`wss://localhost:8080/ws?token=${jwtToken}`);
        let socket;
        let reconnectInterval = 5000; // Ø²Ù…Ø§Ù† Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Ù…Ø¬Ø¯Ø¯ (Ù…ÛŒÙ„ÛŒâ€ŒØ«Ø§Ù†ÛŒÙ‡)
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 100000;

        function connectWebSocket() {
            socket = new WebSocket(`wss://localhost:8443/spring/ws`);

            socket.onopen = () => {
                logMessage("âœ… Ø§ØªØµØ§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯");
                reconnectAttempts = 0; // Ø±ÛŒØ³Øª ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ Ø¨Ø¹Ø¯ Ø§Ø² Ø§ØªØµØ§Ù„ Ù…ÙˆÙÙ‚
            };

            socket.onmessage = (event) => {
                try {
                    const response = JSON.parse(event.data);
                    const icon = response.type === "sender" ? "ğŸ“¤ Ø§Ø±Ø³Ø§Ù„: " : "ğŸ“© Ø¯Ø±ÛŒØ§ÙØª: ";
                    logMessage(icon + response.email + ": " + response.message);
                } catch (e) {
                    logMessage("âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù…: " + e.message);
                }
            };

            socket.onclose = () => {
                logMessage("âŒ Ø§ØªØµØ§Ù„ Ø¨Ø³ØªÙ‡ Ø´Ø¯");
                attemptReconnect();
            };

            socket.onerror = (error) => {
                logMessage("âš ï¸ Ø®Ø·Ø§: " + error.message);
                socket.close(); // Ø¨Ø³ØªÙ† Ø¯Ø³ØªÛŒ Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ onclose
            };
        }

        function attemptReconnect() {
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                logMessage(`ğŸ”„ ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Ù…Ø¬Ø¯Ø¯ (${reconnectAttempts})...`);
                setTimeout(connectWebSocket, reconnectInterval);
            } else {
                logMessage("â›”ï¸ ØªØ¹Ø¯Ø§Ø¯ ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ÛŒ Ø§ØªØµØ§Ù„ Ù…Ø¬Ø¯Ø¯ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯");
            }
        }

        // Ø´Ø±ÙˆØ¹ Ø§ØªØµØ§Ù„
        connectWebSocket();


        function sendMessage() {
            const input = document.getElementById("messageInput");
            const msg = input.value;
            socket.send(msg);
            //logMessage("ğŸ“¤ Ø§Ø±Ø³Ø§Ù„: " + msg);
            input.value = "";
        }

        function logMessage(msg) {
            const messagesDiv = document.getElementById("messages");
            const p = document.createElement("p");
            p.textContent = msg;
            messagesDiv.appendChild(p);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }


        function refreshToken() {
            html5.ajax({
                url: `/spring/refresh/token`,
                method: 'POST',
                headers: {
                    'Accept-Language': 'fa',
                    'Content-Type': 'application/json'//,
                    //'Authorization': 'Bearer your-token'
                },
                body: null,
                responseType: 'json' // ÛŒØ§ 'text', 'xml', 'base64', 'blob', 'arraybuffer'
            }).then(response => {
                //console.log('Status:', response.status);
                //console.log('Headers:', response.headers);
                console.log('Body:', response.body);

            }).catch(error => {
                console.error(error);
            });
        }

        setInterval(refreshToken, 14 * 60000);


</script>


<body>
<a href="/spring/upload">upload</a>
<h2>Ø§Ø±ØªØ¨Ø§Ø· WebSocket Ø¨Ø§ JWT</h2>
<div>
    <input type="text" id="messageInput" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯">
    <button onclick="sendMessage()">Ø§Ø±Ø³Ø§Ù„</button>
</div>
<div id="messages"></div>


</body>

</html>